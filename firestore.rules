rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Admin check function
    function isAdmin() {
      return exists(/databases/$(database)/documents/admins/$(request.auth.uid));
    }
    
    // Helper functions for time are no longer needed for unlocking
    
    // User authentication rules
    match /users/{userId} {
      // Allow users to read/write their own data, and admins to read all users' data
      allow read: if request.auth != null && (request.auth.uid == userId || isAdmin());
      // Allow users to update their own profile, and admins to update or delete any user
      allow write, delete: if request.auth != null && (request.auth.uid == userId || isAdmin());
    }

    // User profiles with subcollections for tracking completed content
    match /user_profiles/{userId} {
      // Allow read/write to the main document for user or admin
      allow read: if request.auth != null && (request.auth.uid == userId || isAdmin());
      // Explicitly allow deletion of any user profile by admin
      allow delete: if request.auth != null && isAdmin();
      allow write: if request.auth != null && (request.auth.uid == userId || isAdmin());
      
      // Allow read/write to all subcollections for user or admin
      match /{subcollection}/{document} {
        allow read: if request.auth != null && (request.auth.uid == userId || isAdmin());
        // Explicitly allow deletion of any subcollection document by admin
        allow delete: if request.auth != null && isAdmin();
        allow write: if request.auth != null && (request.auth.uid == userId || isAdmin());
        
        // Add explicit permission for nested subcollections
        match /{nestedCollection}/{nestedDoc} {
          allow read: if request.auth != null && (request.auth.uid == userId || isAdmin());
          allow write, delete: if request.auth != null && (request.auth.uid == userId || isAdmin());
        }
      }
    }

    // Admin collection
    match /admins/{adminId} {
      allow read: if request.auth != null;
      // Only existing admins can add or remove admin privileges
      allow write, delete: if request.auth != null && isAdmin();
    }

    // User management collection for admin operations
    match /user_management/{document=**} {
      allow read: if request.auth != null && isAdmin();
      allow write, delete: if request.auth != null && isAdmin();
    }

    // Meditation content rules - only admins can write
    match /meditation_content/{document=**} {
      // Allow everyone to read meditation content, but only active content is shown to non-admins by app logic
      allow read: if true;
      // Only admins can write to meditation content
      allow write, delete: if request.auth != null && isAdmin();
    }
    
    // Meditation progress with no time restriction
    match /meditation_progress/{userId} {
      // Allow read for the user's own document or admins
      allow read: if request.auth != null && (
        request.auth.uid == userId || isAdmin()
      );
      
      // Allow initial creation of progress documents for user themselves or by admins
      allow create: if request.auth != null && (
        request.auth.uid == userId || isAdmin()
      );
      
      // For updates, remove time restriction
      allow update: if request.auth != null && (
        request.auth.uid == userId || isAdmin()
      );
      
      allow delete: if request.auth != null && isAdmin();
    }
    
    // Meditation flow collection
    match /meditation_flow/{userId} {
      // Allow read for the user's own document or admins
      allow read: if request.auth != null && (
        request.auth.uid == userId || isAdmin()
      );
      
      // Allow initial creation of flow documents for user themselves or by admins
      allow create: if request.auth != null && (
        request.auth.uid == userId || isAdmin()
      );
      
      // Allow updates with validation for the flow reduction system
      allow update: if request.auth != null && (
        request.auth.uid == userId || isAdmin()
      ) && (
        // When reducing flow, ensure it's not below 0
        request.resource.data.flow >= 0
        // Removed overly restrictive validation for lastMeditationDate which was preventing updates
      );
      
      // Allow admins to delete flow data
      allow delete: if request.auth != null && isAdmin();
    }
    
    // User statistics collection - now shows "Flow" instead of "Streak" in UI
    match /user_stats/{userId} {
      // Allow read for the user's own document or admins
      allow read: if request.auth != null && (
        request.auth.uid == userId || isAdmin()
      );
      
      // Allow initial creation of statistics documents for user themselves or by admins
      allow create: if request.auth != null && (
        request.auth.uid == userId || isAdmin()
      );
      
      // Allow updates for user's own document or admins - including totalFlowLost field
      allow update: if request.auth != null && (
        request.auth.uid == userId || isAdmin()
      );
      
      // Allow admins to delete stats
      allow delete: if request.auth != null && isAdmin();
    }
    
    // Support requests collection for user support
    match /support_requests/{requestId} {
      // Allow users to read their own support requests
      allow read: if request.auth != null && (
        resource.data.userId == request.auth.uid || isAdmin()
      );
      
      // Allow authenticated users to create support requests
      allow create: if request.auth != null && (
        request.resource.data.userId == request.auth.uid
      );
      
      // Only admins can update support request status
      allow update: if request.auth != null && isAdmin();
      
      // Only admins can delete support requests
      allow delete: if request.auth != null && isAdmin();
    }
    
    // Community chat collection for public discussion
    match /community_chat/{messageId} {
      // Anyone who is authenticated can read messages
      allow read: if request.auth != null;
      
      // Users can create their own messages
      allow create: if request.auth != null && (
        request.resource.data.userId == request.auth.uid &&
        request.resource.data.userName is string &&
        request.resource.data.message is string && 
        request.resource.data.message.size() <= 1000
      );
      
      // Only message owners or admins can update messages
      allow update: if request.auth != null && (
        request.auth.uid == resource.data.userId || isAdmin()
      );
      
      // Only message owners or admins can delete messages
      allow delete: if request.auth != null && (
        request.auth.uid == resource.data.userId || isAdmin()
      );
    }
  }
} 