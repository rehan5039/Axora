rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Admin check function
    function isAdmin() {
      return exists(/databases/$(database)/documents/admins/$(request.auth.uid));
    }
    
    // Helper function to calculate time difference in seconds
    function timeDifferenceInSeconds(timeValue) {
      return request.time.toMillis() / 1000 - timeValue.seconds;
    }
    
    // Helper function to check if 24 hours (86400 seconds) have passed
    function has24HoursPassed(timeValue) {
      return timeDifferenceInSeconds(timeValue) >= 86400;
    }

    // User authentication rules
    match /users/{userId} {
      // Allow users to read/write their own data, and admins to read all users' data
      allow read: if request.auth != null && (request.auth.uid == userId || isAdmin());
      // Allow users to update their own profile, and admins to update or delete any user
      allow write, delete: if request.auth != null && (request.auth.uid == userId || isAdmin());
    }

    // User profiles with subcollections for tracking completed content
    match /user_profiles/{userId} {
      // Allow read/write to the main document for user or admin
      allow read: if request.auth != null && (request.auth.uid == userId || isAdmin());
      // Explicitly allow deletion of any user profile by admin
      allow delete: if request.auth != null && isAdmin();
      allow write: if request.auth != null && (request.auth.uid == userId || isAdmin());
      
      // Allow read/write to all subcollections for user or admin
      match /{subcollection}/{document} {
        allow read: if request.auth != null && (request.auth.uid == userId || isAdmin());
        // Explicitly allow deletion of any subcollection document by admin
        allow delete: if request.auth != null && isAdmin();
        allow write: if request.auth != null && (request.auth.uid == userId || isAdmin());
        
        // Add explicit permission for nested subcollections
        match /{nestedCollection}/{nestedDoc} {
          allow read: if request.auth != null && (request.auth.uid == userId || isAdmin());
          allow write, delete: if request.auth != null && (request.auth.uid == userId || isAdmin());
        }
      }
    }

    // Admin collection
    match /admins/{adminId} {
      allow read: if request.auth != null;
      // Only existing admins can add or remove admin privileges
      allow write, delete: if request.auth != null && isAdmin();
    }

    // User management collection for admin operations
    match /user_management/{document=**} {
      allow read: if request.auth != null && isAdmin();
      allow write, delete: if request.auth != null && isAdmin();
    }

    // Meditation content rules - only admins can write
    match /meditation_content/{document=**} {
      // Allow everyone to read meditation content, but only active content is shown to non-admins by app logic
      allow read: if true;
      // Only admins can write to meditation content
      allow write, delete: if request.auth != null && isAdmin();
    }
    
    // Meditation progress with timer enforcement
    match /meditation_progress/{userId} {
      // Allow read for the user's own document or admins
      allow read: if request.auth != null && (
        request.auth.uid == userId || isAdmin()
      );
      
      // Allow initial creation of progress documents without restrictions
      allow create: if request.auth != null && request.auth.uid == userId;
      
      // For updates, enforce the timer rules but ensure anonymous users can update
      // Admins can delete any progress document
      allow update: if request.auth != null && (
        request.auth.uid == userId || isAdmin()
      ) && (
        // Always allow admins to update
        isAdmin() ||
        // Users can always update fields other than currentDay
        !("currentDay" in request.resource.data && request.resource.data.currentDay > resource.data.currentDay) ||
        // Users can only increment currentDay if 24 hours have passed
        has24HoursPassed(resource.data.lastCompletedAt)
      );
      
      allow delete: if request.auth != null && isAdmin();
    }
    
    // Meditation stickers collection
    match /meditation_stickers/{userId} {
      // Allow read for the user's own document or admins
      allow read: if request.auth != null && (
        request.auth.uid == userId || isAdmin()
      );
      
      // Allow initial creation of sticker documents without restrictions
      allow create: if request.auth != null && request.auth.uid == userId;
      
      // Allow updates with basic validation
      allow update: if request.auth != null && (
        request.auth.uid == userId || isAdmin()
      );
      
      // Allow admins to delete stickers
      allow delete: if request.auth != null && isAdmin();
    }
    
    // User statistics collection
    match /user_stats/{userId} {
      // Allow read for the user's own document or admins
      allow read: if request.auth != null && (
        request.auth.uid == userId || isAdmin()
      );
      
      // Allow initial creation of statistics documents
      allow create: if request.auth != null && request.auth.uid == userId;
      
      // Allow updates for user's own document or admins
      allow update: if request.auth != null && (
        request.auth.uid == userId || isAdmin()
      );
      
      // Allow admins to delete stats
      allow delete: if request.auth != null && isAdmin();
    }
  }
} 